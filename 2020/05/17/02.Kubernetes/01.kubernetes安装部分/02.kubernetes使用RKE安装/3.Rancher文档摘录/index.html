<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
	
	<!-- title -->
	
	<title>
	
		Racher使用 | 
	 
	黑月骑马
	</title>
	
	<!-- keywords,description -->
	 

	<!-- favicon -->
	
	<link rel="shortcut icon" href="/favicon.ico">
	
  

	
<link rel="stylesheet" href="/css/main.css">

	
<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css">

	
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/styles/darcula.min.css">


	
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/highlight.min.js"></script>

	
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>

	
<script src="https://cdn.jsdelivr.net/npm/jquery-pjax@2.0.1/jquery.pjax.min.js"></script>

	
<script src="/js/main.js"></script>

	
		
<script src="https://cdn.jsdelivr.net/npm/leancloud-storage/dist/av-min.js"></script>

		
<script src="https://cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js"></script>

	
	
		<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
	
<meta name="generator" content="Hexo 4.2.0"></head>

<body>
	<header id="header">
    <a id="title" href="/" class="logo">黑月骑马</a>

	<ul id="menu">
		<li class="menu-item">
			<a href="/about" class="menu-item-link">ABOUT</a>
		</li>
		
		<li class="menu-item">
			<a href="https://github.com/heiyueqima" class="menu-item-link" target="_blank">
				<i class="fa fa-github fa-2x"></i>
			</a>
		</li>
	</ul>
</header>

	
<div id="sidebar" >
	<button id="sidebar-toggle" class="toggle" ><i class="fa fa-arrow-right " aria-hidden="true"></i></button>
	
	<div id="site-toc" >
		<input id="search-input" class="search-input" type="text" placeholder="search...">
		<div id="tree">
			

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										01.KVM
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										01.KVM安装
									</a>
									
							<ul>
								<li class="file">
									<a href="/2020/05/15/01.KVM/01.KVM%E5%AE%89%E8%A3%85/1.kvm%E7%9A%84%E7%AE%80%E5%8D%95%E5%AE%89%E8%A3%85/">
										1.kvm的简单安装
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										02.Kubernetes
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										01.kubernetes安装部分
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										01.kubernetes使用adm安装
									</a>
									
							<ul>
								<li class="file">
									<a href="/2020/05/17/02.Kubernetes/01.kubernetes%E5%AE%89%E8%A3%85%E9%83%A8%E5%88%86/01.kubernetes%E4%BD%BF%E7%94%A8adm%E5%AE%89%E8%A3%85/01.Kubeadm%E5%AE%89%E8%A3%85kubernetes%E9%9B%86%E7%BE%A4/">
										01.Kubeadm安装kubernetes集群
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										02.kubernetes使用RKE安装
									</a>
									
							<ul>
								<li class="file">
									<a href="/2020/05/15/02.Kubernetes/01.kubernetes%E5%AE%89%E8%A3%85%E9%83%A8%E5%88%86/02.kubernetes%E4%BD%BF%E7%94%A8RKE%E5%AE%89%E8%A3%85/1.RKE%E5%AE%89%E8%A3%85Kubernetes%E9%9B%86%E7%BE%A4/">
										1.RKE安装Kubernetes集群
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/05/15/02.Kubernetes/01.kubernetes%E5%AE%89%E8%A3%85%E9%83%A8%E5%88%86/02.kubernetes%E4%BD%BF%E7%94%A8RKE%E5%AE%89%E8%A3%85/2.Rancher%E5%AE%89%E8%A3%85/">
										2.Rancher安装
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file active">
									<a href="/2020/05/17/02.Kubernetes/01.kubernetes%E5%AE%89%E8%A3%85%E9%83%A8%E5%88%86/02.kubernetes%E4%BD%BF%E7%94%A8RKE%E5%AE%89%E8%A3%85/3.Rancher%E6%96%87%E6%A1%A3%E6%91%98%E5%BD%95/">
										3.Rancher文档摘录
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/05/15/02.Kubernetes/01.kubernetes%E5%AE%89%E8%A3%85%E9%83%A8%E5%88%86/02.kubernetes%E4%BD%BF%E7%94%A8RKE%E5%AE%89%E8%A3%85/4.Rancher%E7%AB%AF%E5%8F%A3/">
										4.Rancher端口
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										05.kubernetes常用服务
									</a>
									
							<ul>
								<li class="file">
									<a href="/2020/05/15/02.Kubernetes/05.kubernetes%E5%B8%B8%E7%94%A8%E6%9C%8D%E5%8A%A1/01.Mongodb%E7%9A%84%E5%89%AF%E6%9C%AC%E9%9B%86/">
										01.Mongodb的副本集
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/05/16/02.Kubernetes/05.kubernetes%E5%B8%B8%E7%94%A8%E6%9C%8D%E5%8A%A1/02.cephfs%E7%9A%84%E5%AE%89%E8%A3%85/">
										02.cephfs的安装
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										07.kubernetes业务搭建
									</a>
									
							<ul>
								<li class="file">
									<a href="/2020/05/16/02.Kubernetes/07.kubernetes%E4%B8%9A%E5%8A%A1%E6%90%AD%E5%BB%BA/01.rocket.chat%E8%81%8A%E5%A4%A9%E7%B3%BB%E7%BB%9F%E6%90%AD%E5%BB%BA/">
										01.rocket.chat聊天系统搭建
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
								</li>
								
							</ul>
			
		</div>
	</div>
</div>

	<!-- 引入正文 -->
	<div id="content">
		<h1 id="article-title">

	3.Rancher文档摘录
</h1>
<div class="article-meta">
	
	<span>HeiYueQiMa</span>
	<span>2020-05-17 04:21:25</span>
    
		<div id="article-categories">
            
                
                    <span>
                        <i class="fa fa-folder" aria-hidden="true"></i>
                        <a href="/categories/Kubernetes/">Kubernetes</a>
						
							>
						
                    </span>
                
            
                
                    <span>
                        <i class="fa fa-folder" aria-hidden="true"></i>
                        <a href="/categories/Kubernetes/Rancher/">Rancher</a>
						
                    </span>
                
            
		</div>
    
</div>

<div id="article-content">
	<h3 id="一-rancher-server-推荐的架构"><a class="markdownIt-Anchor" href="#一-rancher-server-推荐的架构"></a> 一. Rancher server 推荐的架构</h3>
<p>rancher 推荐我们将rancher server的dns解析到一个四层负载器上</p>
<p>四层负载的并发能力比7层的高 方便均匀的使用到所有的节点IP 还能防止单点故障</p>
<blockquote>
<p>这是rancher文档的原话 图片也是取自rancher文档</p>
</blockquote>
<ul>
<li>Rancher 的 DNS 应该解析为 4 层负载均衡器</li>
<li>负载均衡器应将端口 TCP/80 和 TCP/443 流量转发到 Kubernetes 集群中的所有 3 个节点。</li>
<li>Ingress 控制器会将 HTTP 重定向到 HTTPS，并在端口 TCP/443 上终止 SSL/TLS。</li>
<li>Ingress 控制器会将流量转发到 Rancher deployment 中 Pod 上的端口 TCP/80。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/heiyueqima/heiyueqima.github.io/master/images/20200517/rancher1.svg" alt="" /></p>
<p>这个是通过 rancher server管理多个 node cluster 集群<br />
<img src="https://raw.githubusercontent.com/heiyueqima/heiyueqima.github.io/master/images/20200517/rancher2.svg" alt="" /></p>
<hr />
<p>Rancher Server 只能在使用 RKE 或 K3s 安装的 Kubernetes 集群中运行。不支持在托管的 Kubernetes 集群（例如 EKS）上使用 Rancher。</p>
<hr />
<p>其他负载使用rancher server集群可能会导致rancher server的websocket 不稳定</p>
<blockquote>
<p>重要: 安装后，请勿使用此负载均衡器（即local集群 Ingress）对 Rancher 以外的应用程序进行负载均衡。与其他应用程序共享此 Ingress 可能会在其他应用的 Ingress 配置重新加载后导致 Rancher 出现 websocket 错误。我们建议将local集群专用于 Rancher，而不应使用其他任何应用程序</p>
</blockquote>
<h3 id="二-rancher-server-安装的建议"><a class="markdownIt-Anchor" href="#二-rancher-server-安装的建议"></a> 二. Rancher Server 安装的建议</h3>
<blockquote>
<p>Rancher 中国技术支持团队建议您使用“您已有的证书” ingress.tls.source=secret 这种方式，从而减少对 cert-manager 的运维成本。</p>
</blockquote>
<p>确实 那个cert-manager是真的很难用</p>
<h3 id="三-rancher-server-四层负载-nginx-的配置文件"><a class="markdownIt-Anchor" href="#三-rancher-server-四层负载-nginx-的配置文件"></a> 三. Rancher Server 四层负载 nginx 的配置文件</h3>
<p>这个配置文件是官方给的 应该一毛钱毛病都没有 赶紧抄下来</p>
<pre class="highlight"><code class="bash">worker_processes 4;
worker_rlimit_nofile 40000;

events {
worker_connections 8192;
}
stream {
upstream rancher_servers_http {
least_conn;
server &lt;IP_NODE_1&gt;:80 max_fails=3 fail_timeout=5s;
server &lt;IP_NODE_2&gt;:80 max_fails=3 fail_timeout=5s;
server &lt;IP_NODE_3&gt;:80 max_fails=3 fail_timeout=5s;
}
server {
listen 80;
proxy_pass rancher_servers_http;
}

    upstream rancher_servers_https {
        least_conn;
        server &lt;IP_NODE_1&gt;:443 max_fails=3 fail_timeout=5s;
        server &lt;IP_NODE_2&gt;:443 max_fails=3 fail_timeout=5s;
        server &lt;IP_NODE_3&gt;:443 max_fails=3 fail_timeout=5s;
    }
    server {
        listen     443;
        proxy_pass rancher_servers_https;
    }

}

</code></pre>
<h3 id="四-racher-server-helm安装的参数重要"><a class="markdownIt-Anchor" href="#四-racher-server-helm安装的参数重要"></a> 四. Racher Server helm安装的参数(重要)</h3>
<p>这里可以开启api审计</p>
<p>我这里有可能不清晰 赶紧 记录一下网址</p>
<blockquote>
<p><a href="https://rancher2.docs.rancher.cn/docs/installation/options/helm2/helm-rancher/chart-options/_index#%E9%AB%98%E7%BA%A7%E9%80%89%E9%A1%B9" target="_blank" rel="noopener">helm charts详细参数</a></p>
</blockquote>
<h4 id="rancher-charts通用选项"><a class="markdownIt-Anchor" href="#rancher-charts通用选项"></a> rancher charts通用选项</h4>
<table>
<thead>
<tr>
<th>选项</th>
<th>默认值</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>hostname</td>
<td>&quot; &quot;</td>
<td>string - 您的 Rancher Server 的 FQDN</td>
</tr>
<tr>
<td>ingress.tls.source</td>
<td>“rancher”</td>
<td>string - 从哪里获取 ingress 的证书 - “rancher, letsEncrypt, secret”</td>
</tr>
<tr>
<td>letsEncrypt.email</td>
<td>&quot; &quot;</td>
<td>string - 您的邮箱地址</td>
</tr>
<tr>
<td>letsEncrypt.environment</td>
<td>“production”</td>
<td>string - 可选项: “staging, production”</td>
</tr>
<tr>
<td>privateCA</td>
<td>false</td>
<td>bool - 如果您的证书是通过私有 CA 签发的，那么您需要设置这个值为true</td>
</tr>
</tbody>
</table>
<h4 id="rancher-charts高级选项-应该要多设置设置"><a class="markdownIt-Anchor" href="#rancher-charts高级选项-应该要多设置设置"></a> rancher charts高级选项 应该要多设置设置</h4>
<table>
<thead>
<tr>
<th>选项</th>
<th>默认值</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>additionalTrustedCAs</td>
<td>false</td>
<td>bool - 请参阅 附加授信 CA</td>
</tr>
<tr>
<td>addLocal</td>
<td>“auto”</td>
<td>string - 使 Rancher 发现并且导入&quot;local&quot; Rancher Server 集群 导入的&quot;local&quot;集群</td>
</tr>
<tr>
<td>antiAffinity</td>
<td>“preferred”</td>
<td>string - Rancher Pod 反亲和性规则 - “preferred, required”</td>
</tr>
<tr>
<td>auditLog.destination</td>
<td>“sidecar”</td>
<td>string - 发送审计日志到 sidecar 容器的 console，还是发送到 hostPath 卷 - “sidecar, hostPath”</td>
</tr>
<tr>
<td>auditLog.hostPath</td>
<td>“/var/log/rancher/audit”</td>
<td>string - 主机上的日志文件目标地址 (仅在 auditLog.destination 的值为 hostPath时可用)</td>
</tr>
<tr>
<td>auditLog.level</td>
<td>0</td>
<td>int - 设置API 审计日志等级。0 代表关闭。[0-3]</td>
</tr>
<tr>
<td>auditLog.maxAge</td>
<td>1</td>
<td>int - 保留旧审计日志的最大天数 (仅在 auditLog.destination 的值为 hostPath时可用)</td>
</tr>
<tr>
<td>auditLog.maxBackups</td>
<td>1</td>
<td>int - 保留旧审计日志的最大文件个数 (仅在 auditLog.destination 的值为 hostPath时可用)</td>
</tr>
<tr>
<td>auditLog.maxSize</td>
<td>100</td>
<td>int - 在审计日志被轮换前的以 M 为单位的最大容量 (仅在 auditLog.destination 的值为 hostPath时可用)</td>
</tr>
<tr>
<td>busyboxImage</td>
<td>“busybox”</td>
<td>string - 用来收集审计日志的 busybox 镜像的地址。注意：从 v2.2.0 开始可用</td>
</tr>
<tr>
<td>debug</td>
<td>false</td>
<td>bool - 设置 Rancher Server 的 debug 参数</td>
</tr>
<tr>
<td>extraEnv</td>
<td>[]</td>
<td>list - 设置 Rancher Server 的额外环境变量 注意：从 v2.2.0 开始可用</td>
</tr>
<tr>
<td>imagePullSecrets</td>
<td>[]</td>
<td>list - 一列包含私有镜像仓库登录凭证的密文名称。</td>
</tr>
<tr>
<td>ingress.extraAnnotations</td>
<td>{}</td>
<td>map - 加到 ingress 中的额外 annotation，从而自定义 ingress</td>
</tr>
<tr>
<td>ingress.configurationSnippet</td>
<td>“”</td>
<td>string - 添加额外的 Nginx 配置。可以用来配置代理。注意：从 v2.0.15, v2.1.10 和 v2.2.4 开始可用</td>
</tr>
<tr>
<td>proxy</td>
<td>“”</td>
<td>string - 给 Rancher 配置 HTTP[S] 代理</td>
</tr>
<tr>
<td>noProxy</td>
<td>127.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16</td>
<td>string - 通过逗号分隔的一列不使用搭理的 hostnames 或 ip 地址。</td>
</tr>
<tr>
<td>resources	{}</td>
<td>map - Rancher pod 的资源预留和资源限制。</td>
<td></td>
</tr>
<tr>
<td>rancherImage</td>
<td>“rancher/rancher”</td>
<td>string - Rancher 镜像的地址</td>
</tr>
<tr>
<td>rancherImageTag</td>
<td>same as chart version</td>
<td>string - rancher/rancher 镜像标签</td>
</tr>
<tr>
<td>tls</td>
<td>“ingress”</td>
<td>string - 请参阅 外部 TLS Termination - “ingress, external”</td>
</tr>
<tr>
<td>systemDefaultRegistry</td>
<td>“”</td>
<td>string - 全部系统组件相关的 Docker 镜像的私有仓库地址。例如：<a href="http://registry.example.com/" target="_blank" rel="noopener">http://registry.example.com/</a> 注意：从 v2.3.0 开始可用</td>
</tr>
<tr>
<td>useBundledSystemChart</td>
<td>false</td>
<td>bool - 选择是否用打包在 Rancher Server 容器内的system-charts。这个参数是针对离线环境使用的。注意：从 v2.3.0 开始可用</td>
</tr>
</tbody>
</table>
<h4 id="开启api审计"><a class="markdownIt-Anchor" href="#开启api审计"></a> 开启api审计</h4>
<pre class="highlight"><code class="bash">--<span class="hljs-built_in">set</span> auditLog.level=1
</code></pre>
<hr />
<p>默认情况下，启用审计日志将在 Rancher pod 中创建一个 sidecar 容器。这个容器（rancher-audit-log）会将日志流传输到stdout。您可以像收集任何容器日志一样收集此日志。将 sidecar 用作审计日志时，hostPath，maxAge，maxBackups和maxSize选项不适用。建议使用您的操作系统或 Docker 守护进程的日志轮换功能来控制磁盘空间的使用。为 Rancher Server 启用Rancher 工具中的集群日志服务或Rancher 工具中的项目日志服务。。<br />
将auditLog.destination设置为hostPath的值，以将日志转发至与主机系统共享的卷，而不是流至 Sidecar 容器。将目标设置为hostPath时，您可能需要调整其他 auditLog 参数以进行日志轮换。</p>
<hr />
<h4 id="设置额外环境变量"><a class="markdownIt-Anchor" href="#设置额外环境变量"></a> 设置额外环境变量</h4>
<pre class="highlight"><code class="bash">--<span class="hljs-built_in">set</span> <span class="hljs-string">'extraEnv[0].name=CATTLE_TLS_MIN_VERSION'</span>
--<span class="hljs-built_in">set</span> <span class="hljs-string">'extraEnv[0].value=1.0'</span>
</code></pre>
<hr />
<p>您可以使用extraEnv为 Rancher Server 设置额外的环境变量。该列表使用与容器清单定义相同的name和value键。记住需要给值加上双引号。</p>
<hr />
<h4 id="开启rancher对local集群导入"><a class="markdownIt-Anchor" href="#开启rancher对local集群导入"></a> 开启rancher对local集群导入</h4>
<blockquote>
<p>注意事项: 此选项仅在第一次安装 Rancher 时有效</p>
</blockquote>
<p>这个最好还是不要设置</p>
<pre class="highlight"><code class="bash">--<span class="hljs-built_in">set</span> addLocal=<span class="hljs-string">"false"</span>
</code></pre>
<p>默认情况下，Rancher Server 将检测并导入正在运行的local集群。有权访问local集群的用户实际上将具有对 Rancher Server 管理的所有集群的root访问权。</p>
<h4 id="添加ingress-注解"><a class="markdownIt-Anchor" href="#添加ingress-注解"></a> 添加ingress 注解</h4>
<p>设置访问后端的协议是 https 这里的.好像需要转义 等会去试一下</p>
<pre class="highlight"><code class="bash">--<span class="hljs-built_in">set</span> ingress.extraAnnotations.<span class="hljs-string">'nginx\.ingress\.kubernetes\.io/backend-protocol'</span>=HTTPS
</code></pre>
<h3 id="五-针对大型部署的-etcd-调优"><a class="markdownIt-Anchor" href="#五-针对大型部署的-etcd-调优"></a> 五. 针对大型部署的 etcd 调优</h3>
<blockquote>
<p>摘录官方文档  这个优化是在RKE部署的时候进行的</p>
</blockquote>
<h4 id="rke-keyspace设置"><a class="markdownIt-Anchor" href="#rke-keyspace设置"></a> RKE keyspace设置</h4>
<p>etcd 的默认的 keyspace 大小为 2GB，上限为 8GB。当您运行具有 15 个或更多集群的大型 Rancher 安装时，建议您扩大 keyspace 容量和主机大小。如果您预计在垃圾回收间隔期间容器的变化率很高，在较小的安装中也可以调整 keyspace 大小，适应变化率。</p>
<p>Kubernetes 每隔五分钟会自动清理一次 etcd 数据集。如果发生了部署抖动，Kubernetes 会在垃圾回收发生之前，将足够多的事件写入 etcd。五分钟后，Kubernetes 执行自动清理时，会将 etcd 数据集删除，清理所有内容，导致 keyspace 被填满。如果在 etcd 日志或 Kubernetes API 服务器日志中看到mvcc: database space exceeded错误，您可以通过在 etcd 服务器上设置quota-backend-bytes。增加 keyspace 的大小。</p>
<pre class="highlight"><code class="yaml"><span class="hljs-comment">## RKE cluster.yml</span>
<span class="hljs-comment">## 这个是在RKE部署的时候 进行的 这里调整的是5G </span>
<span class="hljs-comment">## 这个是个很重要的参数 </span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">etcd:</span>
    <span class="hljs-attr">extra_args:</span>
      <span class="hljs-attr">quota-backend-bytes:</span> <span class="hljs-number">5368709120</span>

</code></pre>
<h4 id="扩展etcd磁盘性能"><a class="markdownIt-Anchor" href="#扩展etcd磁盘性能"></a> 扩展etcd磁盘性能</h4>
<p>这里备上etcd文档地址 后需要看的</p>
<blockquote>
<p><a href="https://etcd.io/docs/v3.4.0/tuning/#disk" target="_blank" rel="noopener">ETCD文档</a></p>
</blockquote>
<p>另外，为了减少 etcd 磁盘上的 IO 争用，可以将专用设备放在 data 和 wal 目录下。另外，etcd 最佳实践中有说明 etcd 的特性：etcd 会在集群中的节点之间复制数据，所以镜像 RAID 配置是不必要的。您可以不配置 RAID 镜像，使用这部分计算资源增加可用的 IOPS，提升磁盘性能。</p>
<p>要在 RKE 集群中实施此解决方案，/var/lib/etcd/data 和 /var/lib/etc/wal目录将需要在底层主机上挂载磁盘并对其进行格式化。在etcd服务的extra_args指令中，必须包含wal_dir目录。如果不指定wal_dir，则 etcd 进程将尝试在wal权限不足的情况下操纵基础安装。</p>
<pre class="highlight"><code class="yaml"><span class="hljs-comment">## RKE cluster.yml</span>
<span class="hljs-comment">## 将ETCD 的目录绑定到本地的什么目录</span>
<span class="hljs-comment">## 还有就是extra_binds 这个参数要用起来</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">etcd:</span>
    <span class="hljs-attr">extra_args:</span>
      <span class="hljs-attr">data-dir:</span> <span class="hljs-string">"/var/lib/rancher/etcd/data/"</span>
      <span class="hljs-attr">wal-dir:</span> <span class="hljs-string">"/var/lib/rancher/etcd/wal/wal_dir"</span>
    <span class="hljs-attr">extra_binds:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"/var/lib/etcd/data:/var/lib/rancher/etcd/data"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"/var/lib/etcd/wal:/var/lib/rancher/etcd/wal"</span>
</code></pre>
<h4 id="etcd-定期拍照"><a class="markdownIt-Anchor" href="#etcd-定期拍照"></a> ETCD 定期拍照</h4>
<p>需要在RKE集群安装的时候 进行设置</p>
<pre class="highlight"><code class="yaml"><span class="hljs-attr">services:</span>
  <span class="hljs-attr">etcd:</span>
    <span class="hljs-attr">backup_config:</span>
      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 设置true启用ETCD自动备份，设置false禁用；</span>
      <span class="hljs-attr">interval_hours:</span> <span class="hljs-number">6</span> <span class="hljs-comment"># 快照创建间隔时间，单位小时；</span>
      <span class="hljs-attr">retention:</span> <span class="hljs-number">60</span> <span class="hljs-comment"># 快照保留天数(以天为单位)</span>
      <span class="hljs-comment"># Optional S3</span>
      <span class="hljs-attr">s3backupconfig:</span>
        <span class="hljs-attr">access_key:</span> <span class="hljs-string">"myaccesskey"</span>
        <span class="hljs-attr">secret_key:</span> <span class="hljs-string">"myaccesssecret"</span>
        <span class="hljs-attr">bucket_name:</span> <span class="hljs-string">"my-backup-bucket"</span>
        <span class="hljs-attr">folder:</span> <span class="hljs-string">"folder-name"</span> <span class="hljs-comment"># Available as of v2.3.0</span>
        <span class="hljs-attr">endpoint:</span> <span class="hljs-string">"s3.eu-west-1.amazonaws.com"</span>
        <span class="hljs-attr">region:</span> <span class="hljs-string">"eu-west-1"</span>

</code></pre>
<p>RKE 会在每个 etcd 节点上定时拍摄快照，并将快照将保存到每个 etcd 节点的：/opt/rke/etcd-snapshots/目录下。如果配置了 S3 存储配置，快照备份也会上传到 S3 兼容的存储后端。</p>
<h4 id="etcd手动拍照并上传s3"><a class="markdownIt-Anchor" href="#etcd手动拍照并上传s3"></a> ETCD手动拍照并上传S3</h4>
<p>RKE 为在每个节点上运行的 etcd 拍摄快照。该文件将保存到 <strong>/opt/rke/etcd-snapshots</strong>。</p>
<pre class="highlight"><code class="bash">rke etcd snapshot-save --name etcd.db  --config rke-cluster.yaml
</code></pre>
<p>ETCD 手动备份上传S3 我这里传的是minio</p>
<pre class="highlight"><code class="bash">rke etcd snapshot-save --config rke-cluster.yaml --name etcd20200517 --s3 --access-key admin --secret-key <span class="hljs-string">"123456"</span> --bucket-name chat --s3-endpoint  minio.xx.xxx.com 
</code></pre>
<h4 id="etcd手动恢复"><a class="markdownIt-Anchor" href="#etcd手动恢复"></a> ETCD手动恢复</h4>
<p>这个恢复一般不常有 我就只贴一个URL吧</p>
<p><a href="https://rancher2.docs.rancher.cn/docs/backups/restorations/ha-restoration/_index" target="_blank" rel="noopener">官方恢复文档</a></p>
<p>手动恢复etcd</p>
<pre class="highlight"><code class="bash">rke etcd snapshot-restore --name &lt;snapshot&gt;.db --config ./rancher-cluster-restore.yml
</code></pre>
<blockquote>
<p>请记住将新的 RKE 配置 rancher-cluster-restore.yml 和 Kubectl 凭据 kube_config_rancher-cluster-restore.yml 保存在安全的地方，以备将来维护。</p>
</blockquote>
<h3 id="六-rancher部署策略以及生产环境建议"><a class="markdownIt-Anchor" href="#六-rancher部署策略以及生产环境建议"></a> 六. Rancher部署策略以及生产环境建议</h3>
<h4 id="rancher部署策略"><a class="markdownIt-Anchor" href="#rancher部署策略"></a> Rancher部署策略</h4>
<p>个人更喜欢单个集群 单个rancher的方式</p>
<ul>
<li>
<p>单个集群 单个rancher</p>
<p>优点</p>
<ul>
<li>即使另一个区域的控制平面发生故障，本区域内的 Rancher 功能仍然可以保持运行状态。</li>
<li>网络延迟大大降低，提高 Rancher 的性能。</li>
<li>Rancher 控制平面的升级可以在每个区域独立完成</li>
</ul>
<p>缺点</p>
<ul>
<li>管理多个 Rancher 安装的开销。</li>
<li>需要在多个界面中才能查看到全球所有的 Kubernetes 集群</li>
<li>在 Rancher 中部署多集群应用时，需要在每个 Rancher Server 中重复这个过程。</li>
</ul>
</li>
<li>
<p>多节点 单rancher</p>
<p>优点</p>
<ul>
<li>环境可以具有跨区域的节点和网络连接。</li>
<li>单一控制平面界面，查看所有区域和环境。</li>
<li>Kubernetes 不需要 Rancher 操作，并且可以容忍失去与 Rancher 控制平面的连接。</li>
</ul>
<p>缺点</p>
<ul>
<li>受制于网络延迟。</li>
<li>如果控制平面失效，在恢复之前全球范围内无法新建集群。但是，每个 Kubernetes 集群可以继续单独管理。</li>
</ul>
</li>
</ul>
<h4 id="生产环境部署建议"><a class="markdownIt-Anchor" href="#生产环境部署建议"></a> 生产环境部署建议</h4>
<blockquote>
<p>摘录官网</p>
</blockquote>
<p>在生产或者一些很重要的环境中部署 Rancher，应该使用至少有三个节点的高可用 Kubernetes 集群，并在这个集群上面安装 Rancher。</p>
<ol>
<li>
<p>在专用的集群上运行 Rancher</p>
<p>不要在安装 Rancher 的 Kubernetes 集群中运行其他工作负载或微服务。</p>
</li>
<li>
<p>不要在托管的 Kubernetes 环境中运行 Rancher</p>
<ul>
<li>不要用云服务商提供的K8S集群 例如GKE AKS 因为rancher管理不了他们的etcd</li>
<li>使用云服务商的EC2 建立RKE集群 可以方便的备份和恢复集群 云服务的k8s不支持</li>
</ul>
</li>
<li>
<p>确保 Kubernetes 的节点配置正确</p>
<ol>
<li>关闭SWAP</li>
<li>集群节点网络通畅</li>
<li>唯一的主机名</li>
<li>唯一的mac地址</li>
<li>唯一的product_uuids</li>
<li>检查所有需要打开的端口是否打开</li>
<li>为ETCD节点使用SSD硬盘</li>
</ol>
</li>
<li>
<p>使用 RKE 备份状态文件</p>
<ol>
<li>经常性的备份ETCD 默认目录 <strong>/opt/rke/etcd-snapshot</strong></li>
<li>cluster.rkestate非常重要 需要保存好 里面包含了SSL证书信息 需要和集群配置文件放在一起</li>
<li>对于RKE v0.2之前的版本，ETCD 备份会自动将/etc/kubernetes/ssl/目录下的所有证书打包为pki.bundle.tar.gz文件，然后保存在/opt/rke/etcd-snapshot目录中。</li>
</ol>
</li>
<li>
<p>集群中所有节点在同一个数据中心</p>
<p>为了获得最佳性能，请在同一个的数据中心中运行所有集群节点。</p>
<p>这里的是说一个user clutser</p>
</li>
<li>
<p>开发环境和生产环境要尽量一致</p>
<p>强烈建议使用 Rancher 创建staging或pre-production环境的 Kubernetes 集群，这个环境应该在软件和硬件配置方面尽可能的与生产环境相同。</p>
</li>
<li>
<p>监视集群以计划容量</p>
<ul>
<li>rancher 要用好点的硬件</li>
<li>基于指标的容量规划分析应该是扩展 Rancher 的最终指导</li>
<li>使用开源监控解决方案 Prometheus 和 Grafana 的集成来监控集群节点</li>
<li>启动监控以后可以判断关键指标是否合适</li>
</ul>
</li>
</ol>
<h4 id="生产环境容器建议"><a class="markdownIt-Anchor" href="#生产环境容器建议"></a> 生产环境容器建议</h4>
<ol>
<li>
<p>使用通用容器操作系统</p>
<p>尽量不要使用alpine,busybox作为基础镜像 他们更易受到攻击 因为减少了很大的体积</p>
<p>尽量使用Ubuntu centos debian 等基础镜像</p>
</li>
<li>
<p>容器的 scratch 基础镜像</p>
<p>如果你的程序只是一个二进制文件 那么应该使用scratch镜像 这样更安全不易受到攻击</p>
</li>
<li>
<p>使用非特权模式运行容器</p>
<p>尽量不要在容器中使用root权限 这样容易受到攻击</p>
</li>
<li>
<p>资源限制</p>
<p>这个是pod限制资源 1核心的cpu = 1000m</p>
<pre class="highlight"><code class="yaml"><span class="hljs-attr">resources:</span>
  <span class="hljs-attr">limits:</span>
    <span class="hljs-attr">cpu:</span> <span class="hljs-string">300m</span>
    <span class="hljs-attr">memory:</span> <span class="hljs-string">200Mi</span>
</code></pre>
<p>也可以指定cpu个数</p>
<pre class="highlight"><code class="yaml"><span class="hljs-attr">resources:</span>
  <span class="hljs-attr">limits:</span>
    <span class="hljs-attr">cpu:</span> <span class="hljs-string">"1"</span>
    <span class="hljs-attr">memory:</span> <span class="hljs-string">512Mi</span>
</code></pre>
<p>限制pod可以使用的资源，可以帮助你管理工作节点上的资源，避免某个服务内存溢出，影响其他服务。</p>
<p>在 Rancher 中，您可以在项目级别设置资源限制，它们将同步到项目中的所有命名空。</p>
<p>在设置资源配额时，如果您在一个项目或命名空间上设置任何与 CPU 或内存相关的内容(即限制或预留)，那么所有容器都需要在创建的过程中设置相应的 CPU 或内存字段。为了避免在创建工作负载期间对每个容器设置这些限制，您可以在命名空间上指定默认的容器资源限制。</p>
</li>
<li>
<p>资源预留</p>
<p>资源预留配置</p>
<pre class="highlight"><code class="yaml"><span class="hljs-attr">resources:</span>
  <span class="hljs-attr">limits:</span>
    <span class="hljs-attr">cpu:</span> <span class="hljs-string">300m</span>
    <span class="hljs-attr">memory:</span> <span class="hljs-string">200Mi</span>
  <span class="hljs-attr">requests:</span>
    <span class="hljs-attr">cpu:</span> <span class="hljs-string">200m</span>
    <span class="hljs-attr">memory:</span> <span class="hljs-string">100Mi</span>
</code></pre>
<p>您应该将 CPU 和内存需求配置到您的 Pod 上。这对于通知调度器需要将 Pod 放置在哪种类型的计算节点上，并确保它不会过度调度到该节点非常重要。在 Kubernetes 中，您可以在 Pods 容器的spec的resources.requests 请求字段中配置资源请求。</p>
</li>
<li>
<p>配置健康检查（存活检查和就绪检查）</p>
<p>为您的 Pod 配置健康检查（存活检查和就绪检查）。如果不配置健康检查，除非您的 Pod 完全崩溃，否则 Kubernetes 不会知道它是不健康的。</p>
</li>
</ol>
<h4 id="关于规模-安全-可靠性的建议"><a class="markdownIt-Anchor" href="#关于规模-安全-可靠性的建议"></a> 关于规模 安全 可靠性的建议</h4>
<ol>
<li>
<p>在受支持的OS和Docker中运行rancher</p>
<p>Rancher 是基于容器的，可以在任何基于 linux 的操作系统上运行。但是，您应该只在需求文档中列出的操作系统以及支持的 Docker 版本上运行 Rancher。</p>
</li>
<li>
<p>升级Kubernetes版本</p>
<p>让恁的k8s版本保持的新一点 可以少一些安全风险</p>
</li>
<li>
<p>在测试环境随机删除pod</p>
<p>测试集群的自愈能力</p>
</li>
<li>
<p>使用 Terraform 部署复杂的集群</p>
<blockquote>
<p>(这个软件没整明白 Mark一下)</p>
</blockquote>
<p>Rancher UI 的 添加集群 更适合于使用 Kubernetes 集群的初级阶段或简单的用例。但是，对于更复杂或要求更高的用例，建议使用 CLI/API 驱动的方法。我们建议使用 Terraform 作为实现此功能的工具。当您使用带有版本控制和 CI/CD 环境的 Terraform 时，您可以在部署 Kubernetes 集群时获得高度的一致性和可靠性保证。这种方法还提供了最多的定制选项。</p>
<p>Rancher 维护的 Terraform Provider 用于部署 Rancher 2.x 中的集群，它被称为Rancher2 Provider。</p>
</li>
<li>
<p>预生产环境中升级 Rancher</p>
<p>升级rancher的时候 首先在预生产环境升级 升级成功后在升级线上生产环境</p>
</li>
<li>
<p>更新集群证书</p>
<ul>
<li>
<p>应该有多个人给证书的到期时间设置一个提醒</p>
</li>
<li>
<p>最好提前2周进行证书升级</p>
</li>
<li>
<p>rancher 创建的k8s集群证书是10年的</p>
</li>
<li>
<p>对于通过 Rancher 创建的 Kubernetes 集群，证书可以通过 Rancher 用户界面进行更新。</p>
</li>
</ul>
</li>
</ol>

</div>


    <div class="post-guide">
        <div class="item left">
            
              <a href="/2020/05/17/02.Kubernetes/01.kubernetes%E5%AE%89%E8%A3%85%E9%83%A8%E5%88%86/01.kubernetes%E4%BD%BF%E7%94%A8adm%E5%AE%89%E8%A3%85/01.Kubeadm%E5%AE%89%E8%A3%85kubernetes%E9%9B%86%E7%BE%A4/">
                  <i class="fa fa-angle-left" aria-hidden="true"></i>
                  01.Kubeadm安装kubernetes集群
              </a>
            
        </div>
        <div class="item right">
            
              <a href="/2020/05/16/02.Kubernetes/07.kubernetes%E4%B8%9A%E5%8A%A1%E6%90%AD%E5%BB%BA/01.rocket.chat%E8%81%8A%E5%A4%A9%E7%B3%BB%E7%BB%9F%E6%90%AD%E5%BB%BA/">
                
                <i class="fa fa-angle-right" aria-hidden="true"></i>
              </a>
            
        </div>
    </div>




<script>
	
	
</script>
	</div>
	<div id="footer">
	<p>
	©2020-<span id="footerYear"></span> 
	<a href="/">HeiYueQiMa</a> 
	
	
	
</div>
<script type="text/javascript"> 
	document.getElementById('footerYear').innerHTML = new Date().getFullYear() + '';
</script>

	<button id="totop-toggle" class="toggle"><i class="fa fa-angle-double-up" aria-hidden="true"></i></button>
</body>
</html>